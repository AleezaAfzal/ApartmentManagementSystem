@{
    ViewData["Title"] = "Owner Dashboard";

    // Casting viewbag data
    var visits = ViewBag.PendingVisits as List<ApartmentManagement.Models.VisitRequest>;
    var complaints = ViewBag.PendingComplaints as List<ApartmentManagement.Models.Complaint>;
    var bookings = ViewBag.PendingVenueBookings as List<ApartmentManagement.Models.VenueBooking>;

    // DATA PREPARATION FOR CALENDAR
    var bookingDatesJson = "[]";
    if (bookings != null && bookings.Any())
    {
        var dates = bookings.Select(b => b.BookingDate.ToString("yyyy-MM-dd")).ToList();
        bookingDatesJson = System.Text.Json.JsonSerializer.Serialize(dates);
    }
}

<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">

<div class="dashboard-container container-fluid py-4 min-vh-100">
    <div class="content-inner p-2">

        <div class="d-flex justify-content-between align-items-end mb-5">
            <div>
                <h1 class="fw-bold text-dark mb-1 display-6">Good morning, Admin</h1>
                <p class="text-muted mb-0">Here is what's happening in your building today.</p>
            </div>
            <div>
                <button class="btn btn-primary rounded-pill px-4 py-2 shadow-sm">
                    <i class="bi bi-plus-lg me-2"></i>Create Report
                </button>
            </div>
        </div>

        <div class="row g-4 mb-5">
            <div class="col-md-4">
                <div class="card border-0 h-100 hero-card text-white shadow-lg">
                    <div class="card-body p-4 d-flex flex-column justify-content-between">
                        <div class="d-flex justify-content-between align-items-start">
                            <div>
                                <h6 class="text-white-50 text-uppercase fw-semibold mb-1" style="font-size: 0.75rem;">Visit Requests</h6>
                                <h2 class="display-4 fw-bold mb-0">@(visits?.Count ?? 0)</h2>
                            </div>
                            <div class="icon-circle bg-white bg-opacity-25 text-white">
                                <i class="bi bi-calendar-check fs-4"></i>
                            </div>
                        </div>
                        <div class="mt-4">
                            <div class="progress bg-white bg-opacity-25" style="height: 6px;">
                                <div class="progress-bar bg-white" role="progressbar" style="width: 65%"></div>
                            </div>
                            <small class="mt-2 d-block text-white-50">Pending approval action</small>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card border-0 h-100 modern-card shadow-sm">
                    <div class="card-body p-4">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <h6 class="text-muted fw-bold mb-0">Pending Complaints</h6>
                            <div class="icon-circle bg-danger bg-opacity-10 text-danger">
                                <i class="bi bi-exclamation-triangle"></i>
                            </div>
                        </div>
                        <h3 class="fw-bold mb-1 text-dark">@(complaints?.Count ?? 0)</h3>
                        <span class="badge bg-danger bg-opacity-10 text-danger rounded-pill px-2">Action Required</span>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card border-0 h-100 modern-card shadow-sm">
                    <div class="card-body p-4">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <h6 class="text-muted fw-bold mb-0">Confirmed Bookings</h6>
                            <div class="icon-circle bg-success bg-opacity-10 text-success">
                                <i class="bi bi-building-check"></i>
                            </div>
                        </div>
                        <h3 class="fw-bold mb-1 text-dark">@(bookings?.Count ?? 0)</h3>
                        <span class="badge bg-success bg-opacity-10 text-success rounded-pill px-2">Scheduled</span>
                    </div>
                </div>
            </div>
        </div>

        <div class="row g-4">

            <div class="col-lg-8">
                <div class="card border-0 shadow-sm modern-card h-100">
                    <div class="card-header bg-white border-0 py-4 px-4 d-flex justify-content-between align-items-center">
                        <div>
                            <h5 class="fw-bold text-dark mb-0">Upcoming Visits</h5>
                            <small class="text-muted">Tenants awaiting approval</small>
                        </div>
                        <a asp-action="VisitRequests" class="btn btn-light rounded-pill px-3 text-primary fw-bold small">See All</a>
                    </div>
                    <div class="card-body p-0">
                        @if (visits != null && visits.Any())
                        {
                            <div class="table-responsive">
                                <table class="table table-hover align-middle mb-0" style="border-collapse: separate; border-spacing: 0;">
                                    <thead class="bg-light">
                                        <tr>
                                            <th class="ps-4 border-0 text-muted small text-uppercase">Date</th>
                                            <th class="border-0 text-muted small text-uppercase">Tenant</th>
                                            <th class="border-0 text-muted small text-uppercase">Unit</th>
                                            <th class="pe-4 border-0 text-muted small text-uppercase text-end">Action</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        @foreach (var item in visits.Take(6))
                                        {
                                            <tr>
                                                <td class="ps-4 border-bottom-0 py-3">
                                                    <div class="d-flex align-items-center">
                                                        <div class="date-badge text-center me-3">
                                                            <span class="d-block fw-bold fs-5">@item.RequestedDate.Day</span>
                                                            <small class="d-block text-muted text-uppercase" style="font-size: 0.65rem">@item.RequestedDate.ToString("MMM")</small>
                                                        </div>
                                                        <span class="fw-bold text-dark">@item.RequestedTime</span>
                                                    </div>
                                                </td>
                                                <td class="border-bottom-0">
                                                    <div class="d-flex align-items-center">
                                                        <div class="avatar-circle bg-primary bg-opacity-10 text-primary me-2">
                                                            @(string.IsNullOrEmpty(item.User?.FullName) ? "?" : item.User.FullName.Substring(0, 1))
                                                        </div>
                                                        <span class="fw-semibold">@item.User?.FullName</span>
                                                    </div>
                                                </td>
                                                <td class="border-bottom-0">
                                                    <span class="badge bg-light text-dark border">Unit @item.Apartment?.ApartmentNumber</span>
                                                </td>
                                                <td class="pe-4 border-bottom-0 text-end">
                                                    <a asp-action="VisitRequests" class="btn btn-icon btn-sm btn-light text-primary rounded-circle"><i class="bi bi-chevron-right"></i></a>
                                                </td>
                                            </tr>
                                        }
                                    </tbody>
                                </table>
                            </div>
                        }
                        else
                        {
                            <div class="text-center py-5">
                                <i class="bi bi-calendar-x fs-1 opacity-25"></i>
                                <p class="text-muted fw-bold mt-2">No visits pending</p>
                            </div>
                        }
                    </div>
                </div>
            </div>

            <div class="col-lg-4">

                <div class="card border-0 shadow-sm modern-card mb-4">
                    <div class="card-header bg-white border-0 py-3 px-4">
                        <h6 class="fw-bold text-dark mb-0">Recent Complaints</h6>
                    </div>
                    <div class="card-body p-0">
                        @if (complaints != null && complaints.Any())
                        {
                            <div class="list-group list-group-flush">
                                @foreach (var item in complaints.Take(3))
                                {
                                    <div class="list-group-item border-0 px-4 py-3">
                                        <div class="d-flex align-items-center mb-2">
                                            <span class="badge bg-warning bg-opacity-10 text-warning me-2">@item.Status</span>
                                            <small class="text-muted ms-auto">@item.ComplaintDate.ToString("MMM dd")</small>
                                        </div>
                                        <h6 class="fw-bold text-dark mb-1 text-truncate">@item.Title</h6>
                                        <p class="text-muted small mb-0 text-truncate">@item.Description</p>
                                    </div>
                                }
                            </div>
                            <div class="p-3 text-center border-top border-light">
                                <a asp-action="Complaints" class="text-decoration-none text-primary small fw-bold">View All</a>
                            </div>
                        }
                        else
                        {
                            <div class="p-4 text-center text-muted small">No pending complaints</div>
                        }
                    </div>
                </div>

                <div class="card border-0 shadow-sm modern-card overflow-hidden">
                    <div class="calendar-header-gradient p-4 text-white">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <h5 class="fw-bold mb-0" id="currentMonthYear"></h5>
                                <small class="opacity-75">Events & Bookings</small>
                            </div>
                            <div class="d-flex gap-2">
                                <button class="btn btn-sm btn-glass rounded-circle" onclick="changeMonth(-1)"><i class="bi bi-chevron-left"></i></button>
                                <button class="btn btn-sm btn-glass rounded-circle" onclick="changeMonth(1)"><i class="bi bi-chevron-right"></i></button>
                            </div>
                        </div>
                    </div>

                    <div class="card-body p-4 bg-white">
                        <div class="calendar-days-header d-flex justify-content-between text-muted small mb-3 text-uppercase fw-bold" style="font-size: 0.7rem;">
                            <span>Mon</span><span>Tue</span><span>Wed</span><span>Thu</span><span>Fri</span><span>Sat</span><span>Sun</span>
                        </div>
                        <div class="calendar-grid" id="calendarGrid">
                        </div>
                    </div>

                    <div class="bg-light p-3">
                        <h6 class="text-muted text-uppercase fw-bold small mb-3 ps-2">Upcoming Events</h6>
                        @if (bookings != null && bookings.Any())
                        {
                            @foreach (var item in bookings.Take(3))
                            {
                                <div class="bg-white rounded-3 p-3 mb-2 shadow-sm d-flex align-items-center border-start border-4 border-primary">
                                    <div class="me-3 text-center">
                                        <span class="d-block fw-bold text-dark h6 mb-0">@item.BookingDate.Day</span>
                                        <small class="text-muted text-uppercase" style="font-size:0.6rem">@item.BookingDate.ToString("MMM")</small>
                                    </div>
                                    <div class="flex-grow-1">
                                        <h6 class="mb-0 fw-bold text-dark small">@item.VenueType</h6>
                                        <small class="text-muted" style="font-size: 0.75rem">@item.BookingTime</small>
                                    </div>
                                    @if (item.VenueType.ToString().Contains("Hall"))
                                    {
                                        <i class="bi bi-building text-primary opacity-50"></i>
                                    }
                                    else if (item.VenueType.ToString().Contains("Pool"))
                                    {

                                        <i class="bi bi-water text-primary opacity-50"></i>
                                    }
                                    else
                                    {

                                        <i class="bi bi-tree text-primary opacity-50"></i>
                                    }
                                </div>
                            }
                        }
                        else
                        {
                            <p class="text-center text-muted small my-2">No upcoming bookings.</p>
                        }
                    </div>
                </div>

            </div>
        </div>
    </div>
</div>

<style>
    /* Global */
    body {
        font-family: 'Poppins', sans-serif;
        background-color: #f5f7fa !important;
    }

    .dashboard-container {
        background-color: #f5f7fa;
    }

    /* Standard Cards */
    .modern-card {
        border-radius: 24px;
        transition: transform 0.2s ease, box-shadow 0.2s ease;
    }

    .hero-card {
        background: linear-gradient(135deg, #0f172a 0%, #334155 100%);
        border-radius: 24px;
    }

    /* Icons & Badges */
    .icon-circle {
        width: 48px;
        height: 48px;
        border-radius: 14px;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .avatar-circle {
        width: 35px;
        height: 35px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: bold;
        font-size: 0.85rem;
    }

    .btn-icon {
        width: 32px;
        height: 32px;
        padding: 0;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    /* --- BEAUTIFUL CALENDAR STYLES --- */

    /* Header Gradient */
    .calendar-header-gradient {
        background: linear-gradient(45deg, #4f46e5, #818cf8); /* Indigo to Purple */
        position: relative;
    }

    .btn-glass {
        background: rgba(255, 255, 255, 0.2);
        color: white;
        border: none;
        width: 30px;
        height: 30px;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: background 0.2s;
    }

        .btn-glass:hover {
            background: rgba(255, 255, 255, 0.4);
            color: white;
        }

    /* Grid Layout */
    .calendar-days-header span {
        width: 14.28%;
        text-align: center;
    }

    .calendar-grid {
        display: flex;
        flex-wrap: wrap;
        row-gap: 8px;
    }

    /* Day Styling */
    .calendar-day {
        width: 14.28%;
        height: 36px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 0.9rem;
        border-radius: 10px;
        cursor: pointer;
        position: relative;
        color: #4b5563;
        transition: all 0.2s ease;
    }

        .calendar-day:hover:not(.empty) {
            background-color: #f3f4f6;
            color: #111;
        }

        /* "Today" Style */
        .calendar-day.today {
            background-color: #4f46e5; /* Indigo */
            color: white;
            font-weight: 600;
            box-shadow: 0 4px 6px -1px rgba(79, 70, 229, 0.3);
        }

    /* Event Dot */
    .event-dot {
        width: 5px;
        height: 5px;
        background-color: #ec4899; /* Pink pop */
        border-radius: 50%;
        position: absolute;
        bottom: 3px;
    }

    .calendar-day.today .event-dot {
        background-color: #fff;
    }

    .calendar-day.empty {
        cursor: default;
    }

</style>

<script>
    // --- CALENDAR LOGIC ---
    const bookingDates = @Html.Raw(bookingDatesJson);
    let currentDate = new Date();

    function renderCalendar() {
        const monthYear = document.getElementById('currentMonthYear');
        const grid = document.getElementById('calendarGrid');

        grid.innerHTML = "";

        const year = currentDate.getFullYear();
        const month = currentDate.getMonth();

        const monthNames = ["January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December"];
        monthYear.innerText = `${monthNames[month]} ${year}`;

        const firstDay = new Date(year, month, 1).getDay();
        const adjustedFirstDay = firstDay === 0 ? 6 : firstDay - 1;
        const daysInMonth = new Date(year, month + 1, 0).getDate();

        // Empty Slots
        for(let i = 0; i < adjustedFirstDay; i++) {
            const emptyDiv = document.createElement('div');
            emptyDiv.className = 'calendar-day empty';
            grid.appendChild(emptyDiv);
        }

        // Days
        const today = new Date();
        for(let i = 1; i <= daysInMonth; i++) {
            const dayDiv = document.createElement('div');
            dayDiv.className = 'calendar-day';
            dayDiv.innerText = i;

            // Check Today
            if(i === today.getDate() && month === today.getMonth() && year === today.getFullYear()) {
                dayDiv.classList.add('today');
            }

            // Check Events
            const currentMonthStr = (month + 1).toString().padStart(2, '0');
            const currentDayStr = i.toString().padStart(2, '0');
            const dateString = `${year}-${currentMonthStr}-${currentDayStr}`;

            if(bookingDates.includes(dateString)) {
                const dot = document.createElement('div');
                dot.className = 'event-dot';
                dayDiv.appendChild(dot);
            }
            grid.appendChild(dayDiv);
        }
    }

    function changeMonth(delta) {
        currentDate.setMonth(currentDate.getMonth() + delta);
        renderCalendar();
    }

    document.addEventListener('DOMContentLoaded', function() {
        renderCalendar();
    });
</script>